# ReExp (Retail Expansion)

## Design Notes

- CPF that links Client, Fund & Portfolio is not needed for this scenario since a client can only have at most one portfolio so either primary keys can be used in the other table however expansion to allow more than one Portfolio or Fund per client is limited.
  - CPF can easily be cached since it's a very narrow table (comparing to either Client or Portfolio in a production setup).
  - CPF primary key arrangement allows many-to-many scenarios to be implemented with no cost.
- net/http is a fast native library. I don't think a 3rd-party is required or their use is warranted.
  - gin/gin-gonic is currently has the same performance as net/http and is very close to it.
- I used MySQL as RDBMS and tried to apply Postgres best practises, regarding security/naming and administration.
- List {GET /client, GET /fund} end-points are for this demonstration, a LIMIT on the maximum rows returned is always recommended and a best practise.
- All responses are marked with "X-Re-Exp" header and a unique identifier for logging and troubleshooting purpose.
- a short transaction is required during addition of a new portfolio for a client, as two tables need to be updated. As per MySQL transaction isolation one of the nearly simultaneous requests of portfolio for a specific client succeeds. The requester must check the "Status Code" of the response to confirm the successful result of its request.
- Application is split into three contexts:
  - Main/CLI
  - Mux/API endpoints :: for easy addition/modification of endpoints with a clear demarcation from the database access context.
  - DB operations :: only an io.Writer is passed to database components to serialise the data as JSON.
- to keep the data access context agnostic from RDBMS, all queries are only based on SQL standard (SQL:2011) and not therefore using any RDBMS specific extensions.

## Assumptions

- Client table is unencrypted at reset since it holds PPI mainly NI here...
  - One way hash for NI field (and similar) would mitigate the above, however Clients need to confirm their NI every time to compare the hashes.
  - Encryption with PKI -> requires setting up Keys and their rotation.
  - PSK with a key generated by application. Requires safe storage of the key.
- Funds in the existing system are all available to Retail clients...
  - an Opt-Out type filter can be deployed to filter all funds not available here if need be.
- HTTP traffic is not encrypted and need not be for this demo. TLS, however can easily be in place by tweaking few line of Main/CLI context.

## Limits

- 4 billion records per table: Client, Portfolio
  - id can be updated to be BIGINT (64bit) from INT (unsigned), however there can only be 17,576,000,000 NI numbers
- The status code is not logged on the server console.

## External Dependency

- MySQL driver :: github.com/go-sql-driver/mysql
  - (indirect) filippo.io/edwards25519

## Web API: EndPoints

Input/Output format (ie: "Content-Type") is JSON.

- GET /client :: list of all clients (no limits)
  - GET /client/{id} :: details for Client
  - GET /client/{id}/portfolio :: existing Portfolio for the client if any (only one or none)
  - POST /client/{id}/porrtfolio :: POST {"fund":\<id:int\>,"amount":\<amount:int\>[,"name":"\<name:string\>"]} :: will create an entry for the client of the fund with the amount provided. Name of portfolio if provided is used otherwise defaults to: "Client.Name :: Fund.Name".

- GET /fund :: list of all funds (no limits)
  - GET /fund/{id} :: details for Fund

## Database

The file "docker-compose.yml" assumes port 3306 is free and it exposes that port for the MySQL instance in docker.

```bash
$ docker-compose -f docker-compose.yml up
...
```

## HTTP Server

```bash
$ go build .
$ ./main -h
Usage of ./main:
  -dbport int
        MySQL Port (default 3306)
  -port int
        HTTP Port (default 8080)
```

*Also there are two commands:*

- "**randFunds**"
- "**randClients**"

They could generate dummy data as follows if need be:

```bash
$ ./main randFunds
2024/05/21 03:52:09 üëç connected to db server successfully.
2024/05/21 03:52:09 üìÄ generating random Funds ...
2024/05/21 03:52:09 üëç -> {Id:41 Name:Dynamic Sector:Government Type:Sustainable}
...
2024/05/21 03:52:09 üëç -> {Id:50 Name:Dynamic Sector:Health Type:General}
2024/05/21 03:52:09 üëç done.
2024/05/21 03:52:09 üìÄ starting on 8080 ...
```

```bash
$ ./main randClients
2024/05/21 03:53:26 üëç connected to db server successfully.
2024/05/21 03:53:26 üìÄ generating random Clients ...
2024/05/21 03:53:26 üëç -> {Id:81 DOB:2024-05-21 03:53:26.671764 +0100 BST m=+0.004837732 Name:Mr. I. Spark NI:KB617936J}
...
2024/05/21 03:53:26 üëç -> {Id:100 DOB:2024-05-21 03:53:26.749231 +0100 BST m=+0.082304687 Name:Mrs. Q. Kubrik NI:XE627125P}
2024/05/21 03:53:26 üëç done.
2024/05/21 03:53:26 üìÄ starting on 8080 ...
```

## Examples of Operation

Assuming the server is running on port 8080:

- GET /client

```bash
$ curl -s 127.0.0.1:8080/client | jq
[
  {
    "id": 99,
    "dob": "2024-05-21T00:00:00Z",
    "name": "Miss. W. Lee",
    "ni": "FY919299R"
  },

...

  {
    "id": 100,
    "dob": "2024-05-21T00:00:00Z",
    "name": "Mrs. Q. Kubrik",
    "ni": "XE627125P"
  }
]
```

- GET /client/{id}

```bash
$ curl -s 127.0.0.1:8080/client/23 | jq
{
  "id": 23,
  "dob": "2024-05-21T00:00:00Z",
  "name": "Mrs. V. Jupiter",
  "ni": "AL576358E"
}
```

- GET /fund/{id}

```bash
$ curl -s 127.0.0.1:8080/fund/11 | jq
{
  "id": 11,
  "name": "Dynamic",
  "sector": "Technology",
  "type": "General"
}
```

- POST /client/{id}/portfolio

```bash
$ curl -v 127.0.0.1:8080/client/23/portfolio -d '{"fund":11,"amount":25000}'
HTTP/1.1 201 Created
X-Re-Exp: 34
Date: Tue, 21 May 2024 03:53:56 GMT
Content-Length: 0

```

*trying the same POST will be a "**Bad Request**" since the portfolio is already in place for the client:*

```bash
$ curl -v 127.0.0.1:8080/client/23/portfolio -d '{"fund":11,"amount":25000}'
HTTP/1.1 400 Bad Request
X-Re-Exp: 35
Date: Tue, 21 May 2024 03:51:32 GMT
Content-Length: 0

```

- GET /client/{id}/portfolio

```bash
$ curl -s 127.0.0.1:8080/client/23/portfolio
{
 "id": 31,
 "amount": 25000,
 "name": "Mrs. V. Jupiter :: Dynamic",
 "opened_at": "2024-05-21T03:10:19Z",
 "state": 0,
 "fund": 11
}
```
